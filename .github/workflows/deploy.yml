name: Deploy chatbot-ai-service (dev/prod)

on:
  push:
    branches: [ dev, main ]

env:
  GCP_PROJECT_ID: political-referrals
  GCP_REGION: us-central1

jobs:
  deploy:
    name: Deploy chatbot (${{ matrix.env_name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - branch: dev
            env_name: dev
            service_name: chatbot-ai-service-dev
            runtime_env: ENVIRONMENT=development
          - branch: main
            env_name: prod
            service_name: chatbot-ai-service-prod
            runtime_env: ENVIRONMENT=production
    steps:
      - name: Checkout
        if: github.ref_name == matrix.branch
        uses: actions/checkout@v4

      - name: Set up gcloud
        if: github.ref_name == matrix.branch
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Activate service account (gcloud)
        if: github.ref_name == matrix.branch
        run: |
          # Crear el archivo de credenciales usando cat para manejar multilinea
          cat > $RUNNER_TEMP/gcp-key.json << 'EOF'
          ${{ secrets.GCP_SA_KEY }}
          EOF
          
          # Verificar que el archivo se cre√≥ correctamente
          if [ ! -f "$RUNNER_TEMP/gcp-key.json" ]; then
            echo "‚ùå Error: Failed to create gcp-key.json file"
            exit 1
          fi
          
          # Debug: Mostrar informaci√≥n del archivo
          echo "üìã File size: $(wc -c < $RUNNER_TEMP/gcp-key.json) bytes"
          echo "üìã First 200 chars:"
          head -c 200 "$RUNNER_TEMP/gcp-key.json"
          echo ""
          echo "üìã Last 50 chars:"
          tail -c 50 "$RUNNER_TEMP/gcp-key.json"
          echo ""
          
          # Verificar que el JSON es v√°lido
          if ! jq empty "$RUNNER_TEMP/gcp-key.json" 2>/dev/null; then
            echo "‚ùå Error: Invalid JSON in gcp-key.json"
            echo "üìã Full file content for debugging:"
            cat "$RUNNER_TEMP/gcp-key.json"
            exit 1
          fi
          
          # Activar el service account
          gcloud auth activate-service-account --key-file="$RUNNER_TEMP/gcp-key.json"
          gcloud config set project "${{ env.GCP_PROJECT_ID }}"
          echo "‚úÖ Service account activated successfully"

      - name: Verify gcloud auth
        if: github.ref_name == matrix.branch
        run: |
          gcloud auth list
          gcloud config set project "${{ env.GCP_PROJECT_ID }}"

      - name: Deploy ${{ matrix.service_name }}
        if: github.ref_name == matrix.branch
        working-directory: .
        run: |
          gcloud run deploy "${{ matrix.service_name }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --region "${{ env.GCP_REGION }}" \
            --source . \
            --allow-unauthenticated \
            --set-env-vars "${{ matrix.runtime_env }}"

